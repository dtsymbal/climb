<!doctype html>
<head>
    <meta charset="utf-8">

    <title>My Parse App</title>
    <meta name="description" content="My Parse App">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/styles.css">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.16.min.js"></script>
    <script type="text/javascript" src="/phonegap.js"></script>
    <script type="text/javascript" src="/cordova.js"></script>
    <script type="text/javascript" src="/cordova_plugins.js"></script>
</head>

<body>
<div id="fb-root"></div>
<div id="main">
    <h1>You're ready to use Parse!</h1>

    <!--
    <p>Read the documentation and start building your JavaScript app:</p>
    <ul>
        <li><a href="https://www.parse.com/docs/js_guide">Parse JavaScript Guide</a></li>
        <li><a href="https://www.parse.com/docs/js">Parse JavaScript API Documentation</a></li>
    </ul>
    -->

    <h2>Facebook login</h2>
    <button onclick="fbLogin();">Login</button>

    <h2>File Upload</h2>
    <input type="file" id="PhotoFileUpload">

    <div id="info"></div>

    <div style="display:none" class="error">
        Looks like there was a problem saving the test object. Make sure you've set your application ID and javascript
        key correctly in the call to <code>Parse.initialize</code> in this file.
    </div>

    <div style="display:none" class="success">
        <p>We've also just created your first object using the following code:</p>

        <code>
            var TestObject = Parse.Object.extend("TestObject");<br/>
            var testObject = new TestObject();<br/>
        </code>
    </div>
</div>

<script type="text/javascript">
    Parse.initialize("PHjWyI1neIdMLDoUwS90EFLttZzNp6mYN8cfSO8m", "56RkEAtfWj6zIpdXmKA3BuFQGpbCuJJsUQZ9Va6C");

    var TestObject = Parse.Object.extend("TestObject");
    var testObject = new TestObject();
    testObject.fetch({
        success: function (data) {
            $(".success").show();
            $.each(data._serverData.results, function(id, object) {
                $(".success").append('<p>foo: '+object.foo+'</p>');
                if(object.hasOwnProperty('image') && object.image.hasOwnProperty('url')) {
                    $(".success").append('<img src="'+object.image.url+'" width="200" />');
                }
            })

            //console.log(data._serverData.results);
            //console.log(data.attributes.results[3].image.url());
        },
        error: function () {
            //console.log(arguments);
        }
    });
    document.addEventListener('deviceready', function() {
        $("#info").html("device ready");
        /*
        Parse.FacebookUtils.init({
            appId      : '1848100475328918', // Facebook App ID
            status     : true, // check login status
            cookie     : true, // enable cookies to allow Parse to access the session
            xfbml      : true  // parse XFBML
        });
        */
        FB.init({
            appId: '1848100475328918',
            nativeInterface: CDV.FB,
            useCachedDialogs: false
        });
    });
    window.fbAsyncInit = function () {
        $("#info").html("window.fbAsyncInit");
    };

    (function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {
            return;
        }
        js = d.createElement(s);
        js.id = id;
        js.src = "//connect.facebook.net/en_US/all.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    var fbLogin = function(){
        $("#info").html("Login call");
        Parse.FacebookUtils.logIn(null, {
            success: function(user) {
                if (!user.existed()) {
                    $("#info").html("User signed up and logged in through Facebook!");
                } else {
                    $("#info").html("User logged in through Facebook!");
                }
            },
            error: function(user, error) {
                $("#info").html("User cancelled the Facebook login or did not fully authorize.");
            }
        });
    };

    $("#PhotoFileUpload").change(function(){
        var fileUploadControl = $("#PhotoFileUpload")[0];
        if (fileUploadControl.files.length > 0) {
            var file = fileUploadControl.files[0];
            var name = file.name;

            var parseFile = new Parse.File(name, file);
            parseFile.save().then(function(saved) {
                file.url = saved._url;
                file.name = saved._name;
                var testObject = new TestObject();
                testObject.save({
                        foo: "bar",
                        image: file
                    }, {
                    success: function(object) {
                        $(".success").show();
                        $(".success").prepend("saved");
                        //console.log(object);
                    },
                    error: function(model, error) {
                        $(".error").show();
                    }
                });
            }, function(error) {
                // The file either could not be read, or could not be saved to Parse.
            });
        }
    });
    /*
     var testObject = new TestObject();
     testObject.save({foo: "bar"}, {
     success: function(object) {
     $(".success").show();
     console.log(object);
     },
     error: function(model, error) {
     $(".error").show();
     }
     });
     */
</script>
</body>

</html>
